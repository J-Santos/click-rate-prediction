<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
      .loader {
        border: 16px solid #f3f3f3;
        border-radius: 50%;
        border-top: 16px solid #3498db;
        width: 50px;
        height: 50px;
        -webkit-animation: spin 2s linear infinite;
        animation: spin 2s linear infinite;
      }

      @-webkit-keyframes spin {
        0% { -webkit-transform: rotate(0deg); }
        100% { -webkit-transform: rotate(360deg); }
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
</head>
<body>

<div class="container" ng-app="analytics_4" ng-controller="myctrl">
    <h3>Probability of clicks for an Ad ID based on state</h3>
  
  
  <br>
  <br>

  <div class="row">
    <div class="form-group">
        <label for="state" class="col-sm-2 control-label">State</label>
        <div class="col-sm-4">
            <select class="form-control" id="state" name="state" ng-model="state" placeholder="select the state">
                <option value="AK">Alaska</option>
                <option value="AL">Alabama</option>
                <option value="AR">Arkansas</option>
                <option value="AZ">Arizona</option>
                <option value="CA">California</option>
                <option value="CO">Colorado</option>
                <option value="CT">Connecticut</option>
                <option value="DC">District of Columbia</option>
                <option value="DE">Delaware</option>
                <option value="FL">Florida</option>
                <option value="GA">Georgia</option>
                <option value="HI">Hawaii</option>
                <option value="IA">Iowa</option>
                <option value="ID">Idaho</option>
                <option value="IL">Illinois</option>
                <option value="IN">Indiana</option>
                <option value="KS">Kansas</option>
                <option value="KY">Kentucky</option>
                <option value="LA">Louisiana</option>
                <option value="MA">Massachusetts</option>
                <option value="MD">Maryland</option>
                <option value="ME">Maine</option>
                <option value="MI">Michigan</option>
                <option value="MN">Minnesota</option>
                <option value="MO">Missouri</option>
                <option value="MS">Mississippi</option>
                <option value="MT">Montana</option>
                <option value="NC">North Carolina</option>
                <option value="ND">North Dakota</option>
                <option value="NE">Nebraska</option>
                <option value="NH">New Hampshire</option>
                <option value="NJ">New Jersey</option>
                <option value="NM">New Mexico</option>
                <option value="NV">Nevada</option>
                <option value="NY">New York</option>
                <option value="OH">Ohio</option>
                <option value="OK">Oklahoma</option>
                <option value="OR">Oregon</option>
                <option value="PA">Pennsylvania</option>
                <option value="PR">Puerto Rico</option>
                <option value="RI">Rhode Island</option>
                <option value="SC">South Carolina</option>
                <option value="SD">South Dakota</option>
                <option value="TN">Tennessee</option>
                <option value="TX">Texas</option>
                <option value="UT">Utah</option>
                <option value="VA">Virginia</option>
                <option value="VT">Vermont</option>
                <option value="WA">Washington</option>
                <option value="WI">Wisconsin</option>
                <option value="WV">West Virginia</option>
                <option value="WY">Wyoming</option>
            </select>
        </div>
    </div>
  </div>


  

    

    <br>
    <br>
    <div class="row">
    <div class="form-group">
        <label for="state" class="col-sm-2 control-label">Ad ID</label>
        <div class="col-sm-4">
            <input type="text" class="form-control" id="ad_id" ng-model="ad_id" placeholder="Enter ID">
        </div>
    </div>
    </div>

    <br>
    <br>
    <div class="form-group">

        <div class="col-sm-3 col-md-offset-3">
            <input type="submit" class="btn" ng-click="submit()">
            <br><br>
            <div id="spinner" class="loader" style="display: none;"></div>
        </div>
    </div>
<!--
    <div class="row">
        <div class="form-group">

            <div class="col-sm-9 col-md-offset-2">
                <div id="piechart" style="width: 900px; height: 500px;"></div>
            </div>
        </div>
    </div>
-->
    <div class="row">
        <div class="form-group">
            <br><br>
            <div class="col-sm-9 col-md-offset-2 text-primary">
                <h4><b id="probability_text" style="display: none;">This text is bold</b></h4>
            </div>
        </div>
    </div>




    <div class="row">
        <div class="form-group">

            <div class="col-sm-9 col-md-offset-2">
                <div id="linechart_material" style="width: 900px; height: 500px;"></div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="form-group">

            <div class="col-sm-9 col-md-offset-2">
                <div id="chart_div_state" style="width: 900px; height: 500px;"></div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="form-group">

            <div class="col-sm-9 col-md-offset-2">
                <div id="chart_div" style="width: 900px; height: 500px;"></div>
            </div>
        </div>
    </div>


</div>

</body>

<script>

    var app=angular.module("analytics_4",[]);
    app.controller("myctrl",function($scope,$http){

       console.log("inside controller");




       $scope.submit=function(){
          $("#probability_text").hide();
          $("#spinner").removeAttr('style');
           console.log($scope.state);
           console.log($scope.ad_id);
           // console.log($scope.end_date);
           // console.log($scope.start_time);
           // console.log($scope.end_time);
           var request_url = "http://localhost:5000/api/state/"+$scope.state+"/ad_id/"+$scope.ad_id
           //var deferred = $q.defer();
           $http({
               method:'GET',
               url: request_url,
               timeout: 500000
           }).success(function mysuccess(response){
                $("#spinner").hide();
                console.log(response);
                //var probability = ((response.clicks_per_state / response.total_clicks)*(response.ctr))
                //probability = (probability/(response.total_state/response.total_us)) * 100
                //probability = (probability/(1/50))
                ////////////////////
                //                                             P(state | ad is clicked) * P(clicked) 
                // P(Ad is clicked | state) = _____________________________________________________________________________________
                //
                //                            P(state | ad is clicked) * P(clicked) + P(state | ad is NOT clicked) * P(NOT clicked)
                //
                ////////////////////

                var us_count = response.usCluster.clusters[0].length + response.usCluster.clusters[1].length
                var state_count = response.stCluster.clusters[0].length + response.stCluster.clusters[1].length

                var P_state_given_ad_is_clicked = state_count / us_count
                var P_clicked = response.ctr

                var P_state_given_ad_is_NOT_clicked = 1 - P_state_given_ad_is_clicked 
                var P_NOT_clicked = 1 - P_clicked

                var P_ad_is_clicked_given_state = (P_state_given_ad_is_clicked * P_clicked) / (P_state_given_ad_is_clicked * P_clicked + P_state_given_ad_is_NOT_clicked * P_NOT_clicked)                

                var probability_state = 1/50
                var probability_state_given_clicked = state_count/us_count
                console.log("US count: "+ us_count)
                console.log("State count: "+ state_count)
                probability = 1;
                var output_text = "The probability that Ad with id " + response.ad_id + " is clicked for the state of " + response.state
                output_text = output_text + " is " + P_ad_is_clicked_given_state + "."
                //ouis: " + str(probability) ".";
                console.log("probability is: "+P_ad_is_clicked_given_state)

                $("#probability_text").text(output_text);
                $("#probability_text").removeAttr('style');



                 google.charts.load('current', {'packages':['corechart', 'scatter']});
                  google.charts.setOnLoadCallback(drawChart);
                  function drawChart() {
                    var data = new google.visualization.DataTable();
                    console.log("----------------------")
                    console.log(response.state_cluster)
                    data.addColumn('number', 'hour');
                    data.addColumn('number', 'min');
                    data.addColumn('number', 'min');
                    data.addColumn('number', 'min');
                    data.addColumn('number', 'min');
                    //data.addRows(response.state_cluster);

                    var testData = [];
                    // var usClusterRes1 = response.usCluster[0].cluster
                    // for (var i = 0 ; i < usClusterRes1.length ; i++) {
                    //     testData.push([ usClusterRes1[i][0], usClusterRes1[i][1] , null]);
                    // }
                    // console.log(testData)

                    // var testData2 = [];
                    // var usClusterRes2 = response.usCluster[1].cluster
                    // for (var i = 0 ; i < usClusterRes2.length ; i++) {
                    //     testData.push([ usClusterRes2[i][0], null, usClusterRes2[i][1]]);
                    // }
                    // console.log(testData)

                    console.log("------US_Cluster--------------")
                    console.log(response.usCluster)
                    console.log("------US_Cluster--------------")
                    var usClusterRes1 = response.usCluster.clusters[0]
                    for (var i = 0 ; i < usClusterRes1.length ; i++) {
                        testData.push([ usClusterRes1[i][0], usClusterRes1[i][1] , null, null, null]);
                    }
                    console.log(testData)

                    var testData2 = [];
                    var usClusterRes2 = response.usCluster.clusters[1]
                    for (var i = 0 ; i < usClusterRes2.length ; i++) {
                        testData.push([ usClusterRes2[i][0], null, usClusterRes2[i][1], null, null]);
                    }
                    console.log(testData)
                    ///push centroid of cluster 1
                    testData.push([response.usCluster.means[0][0], null, null, response.usCluster.means[0][1], null])
                    testData.push([response.usCluster.means[1][0], null, null, null, response.usCluster.means[1][1]])

                    ///push centroid of cluster 2

                    data.addRows(testData);

                    // var data = google.visualization.arrayToDataTable([
                    //   ['Age', 'Weight'],
                    //   [ 8,      12],
                    //   [ 4,      5.5],
                    //   [ 11,     14],
                    //   [ 4,      5],
                    //   [ 3,      3.5],
                    //   [ 6.5,    7]
                    // ]);

              //       { centroid: [ 48000, 11567 ],
              // cluster: [ [ 91259, 60420 ], [ 400000, 98787 ], [ 48000, 11567 ] ],
              // clusterInd: [ 0, 1, 3 ] }

                    var options = {
                      title: 'Age vs. Weight comparison',
                      hAxis: {title: 'hour', minValue: 0, maxValue: 24},
                      vAxis: {title: 'Weight', minValue: 0, maxValue: 60},
                      legend: 'none',
                      colors: ['#3399ff', '#00ff00', '#cc0000', '#001a00']
                    };

                    //var options = {};

                    var chart = new google.visualization.ScatterChart(document.getElementById('chart_div'));

                    chart.draw(data, options);
                  }

                google.charts.load('current', {'packages':['corechart', 'scatter']});
                google.charts.setOnLoadCallback(drawChartTwo);
                function drawChartTwo() {
                    var data = new google.visualization.DataTable();
                    console.log("----------------------")
                    console.log(response.state_cluster)
                    data.addColumn('number', 'hour');
                    data.addColumn('number', 'min');
                    data.addColumn('number', 'min');
                    data.addColumn('number', 'min');
                    data.addColumn('number', 'min');
                    //data.addRows(response.state_cluster);

                    var stateData = [];
                    // var usClusterRes1 = response.usCluster[0].cluster
                    // for (var i = 0 ; i < usClusterRes1.length ; i++) {
                    //     testData.push([ usClusterRes1[i][0], usClusterRes1[i][1] , null]);
                    // }
                    // console.log(testData)

                    // var testData2 = [];
                    // var usClusterRes2 = response.usCluster[1].cluster
                    // for (var i = 0 ; i < usClusterRes2.length ; i++) {
                    //     testData.push([ usClusterRes2[i][0], null, usClusterRes2[i][1]]);
                    // }
                    // console.log(testData)

                    console.log("------State_Cluster--------------")
                    console.log(response.stCluster)
                    console.log("------State_Cluster--------------")
                    var stateClusterRes1 = response.stCluster.clusters[0]
                    for (var i = 0 ; i < stateClusterRes1.length ; i++) {
                        stateData.push([ stateClusterRes1[i][0], stateClusterRes1[i][1] , null, null, null]);
                    }
                    console.log(stateData)

                    var testData2 = [];
                    var stateClusterRes2 = response.stCluster.clusters[1]
                    for (var i = 0 ; i < stateClusterRes2.length ; i++) {
                        stateData.push([ stateClusterRes2[i][0], null, stateClusterRes2[i][1], null, null]);
                    }
                    console.log(stateData)
                    ///push centroid of cluster 1
                    stateData.push([response.stCluster.means[0][0], null, null, response.stCluster.means[0][1], null])
                    stateData.push([response.stCluster.means[1][0], null, null, null, response.stCluster.means[1][1]])

                    ///push centroid of cluster 2

                    data.addRows(stateData);

                    // var data = google.visualization.arrayToDataTable([
                    //   ['Age', 'Weight'],
                    //   [ 8,      12],
                    //   [ 4,      5.5],
                    //   [ 11,     14],
                    //   [ 4,      5],
                    //   [ 3,      3.5],
                    //   [ 6.5,    7]
                    // ]);

              //       { centroid: [ 48000, 11567 ],
              // cluster: [ [ 91259, 60420 ], [ 400000, 98787 ], [ 48000, 11567 ] ],
              // clusterInd: [ 0, 1, 3 ] }

                    var options = {
                      title: 'Age vs. Weight comparison',
                      hAxis: {title: 'hour', minValue: 0, maxValue: 24},
                      vAxis: {title: 'Weight', minValue: 0, maxValue: 60},
                      legend: 'none',
                      colors: ['#3399ff', '#00ff00', '#cc0000', '#001a00']
                    };

                    //var options = {};

                    var chart = new google.visualization.ScatterChart(document.getElementById('chart_div_state'));

                    chart.draw(data, options);
              }






           }).error(function myerror(err){
               console.log(err);
               // deferred.reject(err)
               // return deferred.promise
           })
       }


    });

</script>

</html>
